#
# ~/.bashrc
#

#function for tmux to kill unpinned unattached panes and log
kill_local_unattached() {
	# Clean up unattached sessions in session groups
	# Keep one session per group if it has pinned panes
	for group in $(tmux list-sessions -F "#{session_group}" 2>/dev/null | sort -u); do
		# Skip sessions not in a group
		[[ -z "$group" ]] && continue

		# Get all sessions in this group
		local sessions=($(tmux list-sessions -F "#{session_name} #{session_group}" 2>/dev/null |
			grep " $group$" |
			awk '{print $1}'))

		# Check if all sessions in group are unattached
		local all_unattached=true
		for session in "${sessions[@]}"; do
			local attached=$(tmux list-sessions -F "#{session_name} #{session_attached}" 2>/dev/null | grep "^$session " | awk '{print $2}')
			if [[ $attached -gt 0 ]]; then
				all_unattached=false
				break
			fi
		done

		# Process based on whether all sessions are unattached
		if [[ $all_unattached == true ]]; then
			# All sessions unattached: check if any window has pinned panes
			local has_pinned=false
			for window in $(tmux list-windows -t "${sessions[0]}" -F "#{window_id}" 2>/dev/null); do
				local window_pinned=$(tmux list-panes -t "$window" -F "#{@pinned}" 2>/dev/null | grep -c "^1$")
				if [[ $window_pinned -gt 0 ]]; then
					has_pinned=true
					break
				fi
			done

			if [[ $has_pinned == true ]]; then
				# Keep the last session (highest numbered), kill the rest
				local sorted_sessions=($(printf '%s\n' "${sessions[@]}" | sort -V))
				local keep_session="${sorted_sessions[-1]}"

				for session in "${sorted_sessions[@]}"; do
					if [[ "$session" != "$keep_session" ]]; then
						echo "Killing extra unattached session in group $group (keeping $keep_session): $session" >>"$HOME/.tmux.log"
						tmux kill-session -t "$session" 2>/dev/null
					fi
				done
			fi
		else
			# At least one session is attached: kill all unattached sessions in group
			for session in "${sessions[@]}"; do
				local attached=$(tmux list-sessions -F "#{session_name} #{session_attached}" 2>/dev/null | grep "^$session " | awk '{print $2}')
				if [[ $attached -eq 0 ]]; then
					echo "Killing unattached session in group $group (group has attached session): $session" >>"$HOME/.tmux.log"
					tmux kill-session -t "$session" 2>/dev/null
				fi
			done
		fi
	done

	# Find unattached windows
	tmux list-windows -a -F "#{window_id} #{window_active_clients}" | sort | uniq 2>/dev/null |
		while read window active_clients; do
			if [[ $active_clients -eq 0 ]]; then
				# Check if window has any pinned panes
				local has_pinned=$(tmux list-panes -t "$window" -F "#{@pinned}" 2>/dev/null | grep -c "^1$")

				if [[ $has_pinned -eq 0 ]]; then
					# No pinned panes, kill entire window
					echo "Killing unattached window (no pinned panes): $window" >>"$HOME/.tmux.log"
					tmux kill-window -t "$window" 2>/dev/null
				else
					# Has pinned panes, kill only unpinned panes
					tmux list-panes -t "$window" -F "#{pane_id} #{@pinned}" 2>/dev/null |
						while read pane_id pinned; do
							if [[ "$pinned" != "1" ]]; then
								echo "Killing unpinned pane in window with pinned panes: $pane_id ($window)" >>"$HOME/.tmux.log"
								tmux kill-pane -t "$pane_id" 2>/dev/null
							fi
						done
				fi
			fi
		done
}
export -f kill_local_unattached
#
# Function to handle tmux session
start_local_session() {
	local pinned=${1:-0}           # Default to unpinned (0)
	local session_name=${2:-local} # Default session name is 'local'
	local unique_id=${3:-}         # Optional unique identifier for pane

	if command -v tmux >/dev/null 2>&1; then

		# If unique_id provided, search for existing pane with that UID
		if [[ -n "$unique_id" ]]; then
			existing_pane=$(tmux list-panes -a -F "#{pane_id} #{@uid}" 2>/dev/null | grep " ${unique_id}$" | head -1 | cut -d' ' -f1)
			if [[ -n "$existing_pane" ]]; then
				# Get the window index of the existing pane
				local existing_window=$(tmux list-panes -a -F "#{window_index} #{pane_id}" 2>/dev/null | grep "$existing_pane" | head -1 | cut -d' ' -f1)

				# Create new linked session pointing to the same group
				view_nr=$(tmux ls | grep -o "${session_name}_[0-9]*:" | grep -o '[0-9]*' | sort -n | tail -1)
				new_view_nr=$((${view_nr:-0} + 1))

				tmux new-session -d -t $session_name -s "${session_name}_${new_view_nr}"

				# Return the new session with the existing window index
				echo "${session_name}_${new_view_nr}:${existing_window}"

				return
			fi
		fi

		# Check if 'local' session exists
		view_nr=$(tmux ls | grep -o "${session_name}_[0-9]*:" | grep -o '[0-9]*' | sort -n | tail -1)

		if [[ -z $view_nr ]]; then
			new_view_nr=0
			tmux new-session -d -t $session_name -s "${session_name}_${new_view_nr}"

			# Set pinned flag and optional UID on the pane
			window_index=0
			pane_target="${session_name}_${new_view_nr}:${window_index}"

			tmux set-option -p -t "$pane_target" @pinned $pinned
			[[ -n "$unique_id" ]] && tmux set-option -p -t "$pane_target" @uid "$unique_id"
		else
			new_view_nr=$((($view_nr + 1)))
			tmux new-session -d -t $session_name -s "${session_name}_${new_view_nr}"

			# Set pinned flag and optional UID on the new pane
			window_index=$(tmux new-window -d -P -F "#{window_index}" -t "${session_name}_${new_view_nr}")

			pane_target="${session_name}_${new_view_nr}:${window_index}"
			tmux set-option -p -t "$pane_target" @pinned $pinned
			[[ -n "$unique_id" ]] && tmux set-option -p -t "$pane_target" @uid "$unique_id"
		fi

		#return value
		echo "${session_name}_${new_view_nr}:${window_index}"

	fi
}
export -f start_local_session

# If not running interactively, don't do anything
[[ $- != *i* ]] && return

PATH=$PATH:~/.local/bin

alias ls='ls --color=auto'
alias grep='grep --color=auto'
PS1='[\u@\h \W]\$ '

get_or_create_session() {
	local pinned=${1:-0}           # Default to unpinned (0)
	local session_name=${2:-local} # Default session name is 'local'
	local unique_id=${3:-}         # Optional unique identifier for pane

	if [[ -z "$TMUX" ]]; then

		# Call start_local_session and capture the return value (session:window)
		local target=$(start_local_session $pinned $session_name $unique_id)

		if [[ -n "$target" ]]; then
			tmux attach-session -t "$target" \; set destroy-unattached
		fi
	fi
}

export -f get_or_create_session
get_or_create_session 0 local
