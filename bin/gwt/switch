#!/bin/bash
  if [[ $# -eq 1 ]]; then
    selected=$1
  else

    currentbranch=$(git branch | grep "*" | sed -e 's/* //')
    activelocal=$(git worktree list | sed -e 's/^.*\[//' | sed -e 's/\]$//')

    selected=$(printf "$activelocal\n$currentbranch" | sort | uniq -u | fzf)

  fi

  if [[ -z $selected ]]; then
    exit 0
  fi

  path=$(git worktree list | grep "$selected" | sed -e 's/ .*$//')
  root=${path:0:(($(echo $path | wc --chars)-$(echo $selected | wc --chars)-1))}
  repo=$(basename ${root})
  brname=${selected/\//-}
  sessionname="${repo}@${brname}"

  # echo $selected
  # echo $path
  # echo $root
  # echo $repo
  # echo $brname
  # echo $sessionname
  # exit

  if [[ -d $path ]]; then
    # sessionname=$selected
    tmux_running=$(pgrep tmux)

    if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
      tmux new-session -s $sessionname -c $path
      exit 0
    fi

    if ! tmux has-session -t $sessionname 2> /dev/null; then
      tmux new-session -ds $sessionname -c $path
    fi

    tmux switch-client -t $sessionname

  fi
